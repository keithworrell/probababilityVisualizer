<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Probabilistic Counter Simulation</title>
    <base href="./src/" />
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>ðŸŽ² Probabilistic Counter Visualization</h1>
      <div class="description">
        Explore how initial probability and decay factor affect the counter's
        journey
        <br /><small style="color: #999"
          >Peak Trajectory mode shows only the maximum value reached in each
          time window. Transparency shows horizontal density.</small
        >
      </div>

      <div class="formula" id="formula">
        P(increment) = <span id="formulaInitial">0.5</span> Ã—
        <span id="formulaDecay">0.98</span>^counter
      </div>

      <div class="preset-buttons">
        <!-- Preset buttons will be dynamically generated -->
      </div>

      <div class="controls-section">
        <div class="section-title">Simulation Parameters (requires re-run)</div>
        <div class="controls">
          <div class="control-group">
            <label for="numRuns">Successful Runs Desired</label>
            <input
              type="number"
              id="numRuns"
              value="100"
              min="10"
              max="1000"
              step="10"
              title="Number of successful completions to achieve (system will keep trying until this many succeed)"
            />
          </div>
          <div class="control-group">
            <label for="maxValue">Target Value</label>
            <input
              type="number"
              id="maxValue"
              value="20"
              min="5"
              max="100"
              step="5"
            />
          </div>
          <div class="control-group">
            <label for="initialProb">Initial Probability</label>
            <input
              type="number"
              id="initialProb"
              value="0.6"
              min="0.01"
              max="1.0"
              step="0.01"
            />
          </div>
          <div class="control-group">
            <label for="decayFactor">Decay Factor</label>
            <input
              type="number"
              id="decayFactor"
              value="0.95"
              min="0.5"
              max="1.5"
              step="0.01"
            />
          </div>
          <button onclick="runSimulation()" id="runButton">Run Simulation</button>
        </div>
      </div>

      <!-- Progress indicator for extended/unlimited phases -->
      <div id="progressIndicator" style="display: none; text-align: center; background: #f0f8ff; border: 2px solid #4a90e2; border-radius: 8px; padding: 15px; font-weight: 600; color: #2c5282;">
        <div id="progressText">Initializing...</div>
        <div style="width: 100%; background: #e2e8f0; border-radius: 10px; height: 20px; margin-top: 10px; overflow: hidden;">
          <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4a90e2, #63b3ed); border-radius: 10px; transition: width 0.3s ease;"></div>
        </div>
        <div id="progressDetails" style="font-size: 12px; color: #4a5568; margin-top: 5px;">Ready to start</div>
        <button id="stopButton" style="display: none; margin-top: 10px; background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 12px;" onclick="if(window.app) window.app.handleStopContinue();">Stop Simulation</button>
      </div>

      <div class="controls-section">
        <div class="section-title">Visualization Settings (instant update)</div>
        <div class="controls">
          <div class="control-group">
            <label for="visualization">Visualization Type</label>
            <select id="visualization" onchange="redrawVisualization()">
              <option value="heatmap">Density Heatmap</option>
              <option value="lines">Individual Lines</option>
              <option value="both">Both</option>
              <option value="peak">Peak Trajectory</option>
            </select>
          </div>
          <div class="control-group">
            <label for="colorScaling">Color Scaling</label>
            <select id="colorScaling" onchange="redrawVisualization()">
              <option value="linear">Linear</option>
              <option value="sqrt">Square Root</option>
              <option value="log">Logarithmic</option>
              <option value="percentile">Percentile</option>
            </select>
          </div>
        </div>
      </div>

      <canvas id="canvas" width="1000" height="520"></canvas>

      <div class="legend">
        <span>Low Density</span>
        <div class="legend-gradient"></div>
        <span>High Density</span>
      </div>

      <div class="stats" id="stats"></div>
    </div>

    <!-- Load and initialize the application -->
    <script type="module">
      import { ProbabilityVisualizer } from './js/ProbabilityVisualizer.js';

      // Initialize the application when the page loads
      window.addEventListener('load', () => {
        try {
          window.app = new ProbabilityVisualizer();
          window.app.init();
        } catch (error) {
          console.error('Failed to start Probability Visualizer:', error);
          alert(`Failed to start application: ${error.message}`);
        }
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (window.app) {
          window.app.destroy();
        }
      });
    </script>
  </body>
</html>